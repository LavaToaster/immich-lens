name: Release tvOS

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Marketing version (e.g. 1.2.0). Defaults to tag or project setting.'
        required: false
        type: string

jobs:
  release-tvos:
    name: Archive & Upload to TestFlight
    runs-on: macos-15
    env:
      ARCHIVE_PATH: build/ImmichLens-tvOS.xcarchive
      EXPORT_PATH: build/export
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode.app

      - name: Derive version info
        id: version
        env:
          INPUT_VERSION: ${{ inputs.version }}
        run: |
          BUILD_NUMBER=$(git rev-list --count HEAD)
          echo "build_number=$BUILD_NUMBER" >> "$GITHUB_OUTPUT"

          if [[ -n "$INPUT_VERSION" ]]; then
            VERSION="$INPUT_VERSION"
            VERSION="${VERSION#v}"
          elif [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION=$(sed -n 's/.*MARKETING_VERSION = \(.*\);/\1/p' ImmichLens.xcodeproj/project.pbxproj | head -1 | tr -d ' ')
          fi

          echo "marketing_version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "### Version Info" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Marketing version:** $VERSION" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Build number:** $BUILD_NUMBER" >> "$GITHUB_STEP_SUMMARY"

      - name: Import code signing certificate
        uses: apple-actions/import-codesign-certs@v3
        with:
          p12-file-base64: ${{ secrets.APPSTORE_CERTIFICATES_FILE_BASE64 }}
          p12-password: ${{ secrets.APPSTORE_CERTIFICATES_PASSWORD }}

      - name: Download provisioning profile
        uses: apple-actions/download-provisioning-profiles@v5
        with:
          bundle-id: dev.lav.ImmichLens
          profile-type: TVOS_APP_STORE
          issuer-id: ${{ vars.APPSTORE_ISSUER_ID }}
          api-key-id: ${{ vars.APPSTORE_API_KEY_ID }}
          api-private-key: ${{ secrets.APPSTORE_API_PRIVATE_KEY }}

      - name: Generate ExportOptions.plist
        env:
          PROFILE_NAME: Immich Lens tvOS App Store Connect
        run: |
          cat > ExportOptions.plist << PLIST
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>app-store-connect</string>
              <key>destination</key>
              <string>export</string>
              <key>signingStyle</key>
              <string>manual</string>
              <key>teamID</key>
              <string>PV3AE7C4X7</string>
              <key>provisioningProfiles</key>
              <dict>
                  <key>dev.lav.ImmichLens</key>
                  <string>${PROFILE_NAME}</string>
              </dict>
          </dict>
          </plist>
          PLIST

      - name: Archive
        env:
          MARKETING_VERSION: ${{ steps.version.outputs.marketing_version }}
          BUILD_NUMBER: ${{ steps.version.outputs.build_number }}
        run: |
          xcodebuild archive \
            -project ImmichLens.xcodeproj \
            -scheme ImmichLens \
            -destination 'generic/platform=tvOS' \
            -archivePath "$ARCHIVE_PATH" \
            -skipPackagePluginValidation \
            MARKETING_VERSION="$MARKETING_VERSION" \
            CURRENT_PROJECT_VERSION="$BUILD_NUMBER" \
            CODE_SIGNING_ALLOWED=NO

      - name: Export archive
        run: |
          xcodebuild -exportArchive \
            -archivePath "$ARCHIVE_PATH" \
            -exportOptionsPlist ExportOptions.plist \
            -exportPath "$EXPORT_PATH"

      - name: Upload to TestFlight
        uses: apple-actions/upload-testflight-build@v3
        with:
          app-path: build/export/ImmichLens.ipa
          app-type: appletvos
          issuer-id: ${{ vars.APPSTORE_ISSUER_ID }}
          api-key-id: ${{ vars.APPSTORE_API_KEY_ID }}
          api-private-key: ${{ secrets.APPSTORE_API_PRIVATE_KEY }}
